[{"createdAt":"2025-06-06T09:38:03.244Z","updatedAt":"2025-07-15T07:09:32.000Z","id":"Ob3B7XMSxqBOUtpK","name":"Prep and Send Batch Messages","active":false,"nodes":[{"parameters":{"inputSource":"passthrough"},"id":"c055762a-8fe7-4141-a639-df2372f30060","typeVersion":1.1,"name":"When Executed by Another Workflow","type":"n8n-nodes-base.executeWorkflowTrigger","position":[260,340]},{"parameters":{"jsCode":"const items = $input.all();\nconst results = [];\n\nfor (const item of items) {\n  const payload = item.json;\n  let customParams = [];\n\n  try {\n    customParams = JSON.parse(payload.customParams);\n  } catch (e) {\n    console.log('Failed to parse customParams for item:', payload);\n    results.push([]); // Push empty array if parsing fails\n    continue;\n  }\n\n  const paramArray = customParams.map(param => {\n    const paramName = param.paramName;\n    let value = payload[paramName] ?? null;\n\n    if (paramName === 'link' && typeof value === 'string') {\n      value = value.slice(18);\n    }\n\n    return {\n      name: paramName,\n      value\n    };\n  });\n\n  results.push(paramArray);\n}\n\nreturn results.map(group => ({ json: { params: group } }));"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[800,480],"id":"5f5426f7-a371-478f-bc67-d07c617c81ed","name":"Code"},{"parameters":{"assignments":{"assignments":[{"id":"eae0d71b-7103-4348-b26f-16903b9fd57c","name":"auth_token","value":"={{ $json.auth_token }}","type":"string"},{"id":"04ad85a3-8b96-441d-ac52-585793b113dc","name":"tenant_id","value":"={{ $json.tenant_id }}","type":"number"},{"id":"f2b76b5c-b3b7-45e2-9cba-ef306e55631c","name":"template_name","value":"={{ $('When Executed by Another Workflow').first().json.template_name }}","type":"string"},{"id":"c350a1cd-2682-4e71-bbf8-6536295d3a2e","name":"receivers","value":"[]","type":"array"},{"id":"382af103-c612-4cbe-8bda-93e9a5dd5aac","name":"broadcast_name","value":"={{ $('When Executed by Another Workflow').first().json.template_name }}_{{ $('Limit').item.json.webinarId }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1400,120],"id":"3129de38-65ad-435f-952c-2dd4a6c17294","name":"Edit Fields"},{"parameters":{"operation":"get","tableId":"wati_auth_tokens","filters":{"conditions":[{"keyName":"tenant_id","keyValue":"={{ $json.wati_account_id }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1080,120],"id":"736b77a2-2766-428b-9173-91ef99c6f14e","name":"Supabase","credentials":{"supabaseApi":{"id":"6stEFLC7gtftREcf","name":"Supabase Campaign manager"}}},{"parameters":{},"type":"n8n-nodes-base.limit","typeVersion":1,"position":[820,120],"id":"65772faf-2731-471f-bf6a-287fcf8bca0c","name":"Limit"},{"parameters":{"mode":"combine","combineBy":"combineByPosition","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.1,"position":[1780,280],"id":"ef445856-5f8e-47a2-a88c-db6ed32a6c02","name":"Merge"},{"parameters":{"assignments":{"assignments":[{"id":"ea3cacbd-eddf-465e-90db-6be305d44c80","name":"whatsappNumber","value":"={{ $('When Executed by Another Workflow').item.json.country_code.replace('+','') }}{{ $('When Executed by Another Workflow').item.json.phone }}","type":"string"},{"id":"45700788-387c-4efc-b783-ad0f696098c2","name":"customParams","value":"={{ $json.params }}","type":"array"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1120,480],"id":"f68caddb-7667-48d7-bc8e-8afcc7489f35","name":"Edit Fields2"},{"parameters":{"aggregate":"aggregateAllItemData","destinationFieldName":"receivers","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[1420,480],"id":"7fa011c8-5eba-4792-a105-28793611a4c6","name":"Aggregate1"},{"parameters":{"method":"POST","url":"=https://live-mt-server.wati.io/{{ $json.tenant_id }}/api/v2/sendTemplateMessages ","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"*/*"},{"name":"Authorization","value":"={{ $json.auth_token }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"template_name","value":"={{ $json.template_name }}"},{"name":"broadcast_name","value":"={{ $json.broadcast_name }}"},{"name":"receivers","value":"={{ $json.receivers }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2000,280],"id":"6705161d-c8c5-4b27-93cc-c66cee53211d","name":"HTTP Request"},{"parameters":{"workflowId":{"__rl":true,"mode":"list","value":"7GQ62XbNUHQLp712","cachedResultName":"My Sub-Workflow 2"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[2240,280],"id":"8067cbdd-5315-4ac8-a307-3868c42fcb13","name":"Batch Log Sent Message"}],"connections":{"When Executed by Another Workflow":{"main":[[{"node":"Limit","type":"main","index":0},{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Edit Fields2","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Limit":{"main":[[{"node":"Supabase","type":"main","index":0}]]},"Supabase":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"Merge":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"Edit Fields2":{"main":[[{"node":"Aggregate1","type":"main","index":0}]]},"Aggregate1":{"main":[[{"node":"Merge","type":"main","index":1}]]},"HTTP Request":{"main":[[{"node":"Batch Log Sent Message","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"When Executed by Another Workflow":[{"json":{"id":164707,"registration_email":"amarjeetkumardas27@gmail.com","webinarId":74,"link":"https://zoom.us/w/94968796029?tk=uwBJoP7FW2w_vCDfKL0mIkaBI-9yj1IGSBsY1aGSekY.DQcAAAAWHJTTfRZ5dkJ2bXFkdlRhYXBndF9pY1NTSmR3AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&uuid=WN_prOGYERDTvyzMoOcBADdjQ","lead_id":8581173,"name":"Amarjeet kumar das","uuid":"390a4c0c-80bc-4323-a1e1-5fb08f0d29fa","phone":"6204595296","country_code":"+91","webinar_name":"Webinar on AI for Business Professionals","webinar_date":"June 7, 2025","webinar_time":"03:00 PM","email":"amarjeetkumardas27@gmail.com","campaign_id":1731,"campaign_name":"Accounting Roadmap D Day Reminder WhatsApp","course_id":58,"customParams":"[{\"paramName\":\"name\",\"paramValue\":\"k\"},{\"paramName\":\"webinar_date\",\"paramValue\":\"k\"},{\"paramName\":\"webinar_time\",\"paramValue\":\"k\"},{\"paramName\":\"link\",\"paramValue\":\"k\"}]","wati_account_id":444763,"template_name":"webinar_reminder_d_1_day_mba_v2"}},{"json":{"id":164689,"registration_email":"varmasatypal983@gmail.com","webinarId":74,"link":"https://zoom.us/w/94968796029?tk=PVrlWmOlUBoWZZ7AwqYzohEz9J1HyijaD8QN0NuzT4E.DQcAAAAWHJTTfRZMY3dva0pSZ1ROVzlXdWJEUjlRZHJnAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&uuid=WN_prOGYERDTvyzMoOcBADdjQ","lead_id":8581165,"name":"Satypal varma ","uuid":"77121a22-07b5-4c03-89f0-9eeba4cee0af","phone":"6355384575","country_code":"+91","webinar_name":"Webinar on AI for Business Professionals","webinar_date":"June 7, 2025","webinar_time":"03:00 PM","email":"varmasatypal983@gmail.com","campaign_id":1731,"campaign_name":"Accounting Roadmap D Day Reminder WhatsApp","course_id":58,"customParams":"[{\"paramName\":\"name\",\"paramValue\":\"k\"},{\"paramName\":\"webinar_date\",\"paramValue\":\"k\"},{\"paramName\":\"webinar_time\",\"paramValue\":\"k\"},{\"paramName\":\"link\",\"paramValue\":\"k\"}]","wati_account_id":444763,"template_name":"webinar_reminder_d_1_day_mba_v2"}},{"json":{"id":164526,"registration_email":"ub24186@gmail.com","webinarId":74,"link":"https://zoom.us/w/94968796029?tk=URMS__WCPIxr26ABB4iPX1yJHhVsoQBcXc-gPTjIVbI.DQcAAAAWHJTTfRZuUk8td2ZDblJnT0MxdWxmLUtDc0hnAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&uuid=WN_prOGYERDTvyzMoOcBADdjQ","lead_id":8581080,"name":"Uttam Behera","uuid":"45249a90-6c7c-4bc5-bcac-b5c24552f3ec","phone":"7847912356","country_code":"+91","webinar_name":"Webinar on AI for Business Professionals","webinar_date":"June 7, 2025","webinar_time":"03:00 PM","email":"ub24186@gmail.com","campaign_id":1731,"campaign_name":"Accounting Roadmap D Day Reminder WhatsApp","course_id":58,"customParams":"[{\"paramName\":\"name\",\"paramValue\":\"k\"},{\"paramName\":\"webinar_date\",\"paramValue\":\"k\"},{\"paramName\":\"webinar_time\",\"paramValue\":\"k\"},{\"paramName\":\"link\",\"paramValue\":\"k\"}]","wati_account_id":444763,"template_name":"webinar_reminder_d_1_day_mba_v2"}},{"json":{"id":164484,"registration_email":"ramgodala67@gmail.com","webinarId":74,"link":"https://zoom.us/w/94968796029?tk=ouvnC1s881vBKq7hNRebqjLUAcgRhnUbiZijwiyqPE8.DQcAAAAWHJTTfRY3WEUtalc4M1JUSzR5YzlWaWxRT21nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&uuid=WN_prOGYERDTvyzMoOcBADdjQ","lead_id":8573735,"name":"G Ram Rajan Reddy","uuid":"c105921f-3706-440c-833c-9efb8b001d1e","phone":"9398275278","country_code":"+91","webinar_name":"Webinar on AI for Business Professionals","webinar_date":"June 7, 2025","webinar_time":"03:00 PM","email":"ramgodala67@gmail.com","campaign_id":1702,"campaign_name":"FB_MBA_in_AI_Product&Business_TG","course_id":58,"customParams":"[{\"paramName\":\"name\",\"paramValue\":\"k\"},{\"paramName\":\"webinar_date\",\"paramValue\":\"k\"},{\"paramName\":\"webinar_time\",\"paramValue\":\"k\"},{\"paramName\":\"link\",\"paramValue\":\"k\"}]","wati_account_id":444763,"template_name":"webinar_reminder_d_1_day_mba_v2"}},{"json":{"id":164483,"registration_email":"Bhumikakalra1300@gmail.com","webinarId":74,"link":"https://zoom.us/w/94968796029?tk=m5vMHJ18ppKyVYuFJZkYjQ3vYeqFjjbSIzlVNL71Hts.DQcAAAAWHJTTfRZBVEZsLUFtV1JaV3BiczM3SjhjMmVnAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&uuid=WN_prOGYERDTvyzMoOcBADdjQ","lead_id":8572586,"name":"Bhumika","uuid":"f3114830-55b5-492e-a8eb-7387957e776d","phone":"9079903266","country_code":"+91","webinar_name":"Webinar on AI for Business Professionals","webinar_date":"June 7, 2025","webinar_time":"03:00 PM","email":"Bhumikakalra1300@gmail.com","campaign_id":1702,"campaign_name":"FB_MBA_in_AI_Product&Business_TG","course_id":58,"customParams":"[{\"paramName\":\"name\",\"paramValue\":\"k\"},{\"paramName\":\"webinar_date\",\"paramValue\":\"k\"},{\"paramName\":\"webinar_time\",\"paramValue\":\"k\"},{\"paramName\":\"link\",\"paramValue\":\"k\"}]","wati_account_id":444763,"template_name":"webinar_reminder_d_1_day_mba_v2"}}]},"versionId":"5a448e87-296b-4078-b941-7f1b84641ed9","triggerCount":0,"tags":[{"createdAt":"2025-07-15T07:07:49.926Z","updatedAt":"2025-07-15T07:07:49.926Z","id":"wJnVPrhSbmXUFztc","name":"martech"}]}]