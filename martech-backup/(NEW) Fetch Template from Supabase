[{"createdAt":"2025-06-04T11:00:55.654Z","updatedAt":"2025-07-15T07:10:33.000Z","id":"dqr4NavCVqG9EN1a","name":"(NEW) Fetch Template from Supabase","active":false,"nodes":[{"parameters":{"inputSource":"passthrough"},"id":"c055762a-8fe7-4141-a639-df2372f30060","typeVersion":1.1,"name":"When Executed by Another Workflow","type":"n8n-nodes-base.executeWorkflowTrigger","position":[260,340]},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[700,340],"id":"fa4dd0e1-2561-47ee-912b-203d214099a3","name":"Loop Over Items"},{"parameters":{"operation":"getAll","tableId":"event_messages_mapping_wati","limit":1,"matchType":"allFilters","filters":{"conditions":[{"keyName":"event_name","condition":"eq","keyValue":"={{ $json[\"event_params.activity_name\"] }}"},{"keyName":"isActive","condition":"eq","keyValue":"true"},{"keyName":"program_id","condition":"eq","keyValue":"={{ $json[\"payload_params.course_id\"] ?? 9999 }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[960,440],"id":"0d862eda-37c7-4ff7-a342-4813d9da577c","name":"Supabase","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"6stEFLC7gtftREcf","name":"Supabase Campaign manager"}}},{"parameters":{"jsCode":"// Step 1: Parse the stringified JSON inside body.data\nconst rawData =  $input.first().json.body.data;\nlet parsed;\n\ntry {\n  parsed = JSON.parse(rawData);\n} catch (e) {\n  throw new Error('Invalid JSON in body.data');\n}\n\nconst inputArray = parsed.mileseducationcee;\n\nif (!Array.isArray(inputArray)) {\n  throw new Error('mileseducationcee is not an array');\n}\n\n// Step 2: Helper to flatten nested objects\nfunction flattenObject(obj, parentKey = '', result = {}) {\n  for (let key in obj) {\n    const propKey = parentKey ? `${parentKey}.${key}` : key;\n    if (typeof obj[key] === 'object' && obj[key] !== null && !Array.isArray(obj[key])) {\n      flattenObject(obj[key], propKey, result);\n    } else {\n      result[propKey] = obj[key];\n    }\n  }\n  return result;\n}\n\n// Step 3: Map over the array and flatten each object\nconst output = inputArray.map(entry => {\n  return { json: flattenObject(entry) };\n});\n\nreturn output;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[460,340],"id":"68a0f75d-8b7d-4307-9850-e676a53fc9c1","name":"Code","alwaysOutputData":true},{"parameters":{"operation":"get","tableId":"wati_message_templates","filters":{"conditions":[{"keyName":"template_name","keyValue":"={{ $json.template_name }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1500,420],"id":"5ead2d74-30bf-4ac3-9f7e-5100b0075f57","name":"Supabase1","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"6stEFLC7gtftREcf","name":"Supabase Campaign manager"}}},{"parameters":{"assignments":{"assignments":[{"id":"da505685-a9cf-44b9-a5a0-9c616238598d","name":"parameters","value":"={{ $json.customParams }}","type":"array"},{"id":"2b6575e3-d8d7-4cfa-867a-6d389ada9928","name":"template_name","value":"={{ $json.template_name }}","type":"string"},{"id":"61da49d7-3f6d-4210-a476-9d5ccba31c9b","name":"broadcast_name","value":"={{ $json.template_name }}","type":"string"},{"id":"0c089ccf-477f-4648-883b-2b3f9715eb37","name":"tenant_id","value":"={{ $json.wati_account_id }}","type":"string"},{"id":"477e9bf8-4dd7-4335-abd6-3be365c2d1f2","name":"event_name","value":"={{ $('Loop Over Items').item.json[\"event_params.activity_name\"] }}","type":"string"},{"id":"d5d33150-0875-4c2c-a9ca-5df8af798208","name":"email","value":"={{ $('Loop Over Items').item.json[\"payload_params.email\"] }}","type":"string"},{"id":"0c400c3f-0590-4164-9b8a-7cf1025feeaa","name":"lead_id","value":"={{ $('Loop Over Items').item.json[\"payload_params.lead_id\"] }}","type":"string"},{"id":"25d38b8c-d7e6-472f-acda-2340f9224aef","name":"phone","value":"={{ $('Loop Over Items').item.json[\"payload_params.phone\"] }}","type":"string"},{"id":"bed3d8e9-288a-4148-866e-d6e65b1e48f5","name":"webinar_date","value":"={{ $('Loop Over Items').item.json[\"payload_params.webinar_date\"] }}","type":"string"},{"id":"da810208-1d9e-42cb-999a-66a1cb3a5a02","name":"webinar_time","value":"={{ $('Loop Over Items').item.json[\"payload_params.webinar_time\"] }}","type":"string"},{"id":"a5d63db1-bb76-4411-849d-3e85bf9be69e","name":"link","value":"={{ $('Loop Over Items').item.json[\"payload_params.join_url\"] }}","type":"string"},{"id":"68eecac2-4ac0-4dff-b325-7da7b1db36a6","name":"name","value":"={{ $('Loop Over Items').item.json[\"payload_params.first_name\"] }}","type":"string"},{"id":"501b4540-8fd7-414a-9210-961f1a0cf571","name":"visit_date","value":"={{ $('Loop Over Items').item.json[\"payload_params.visit_date\"] }}","type":"string"},{"id":"4fb2abbb-638a-43c4-82bd-ab4573458d0f","name":"visit_time","value":"={{ $('Loop Over Items').item.json[\"payload_params.visit_time\"] }}","type":"string"},{"id":"cf5ce8c7-4a07-48cc-85d8-be173ff84a3f","name":"visit_type","value":"={{ $('Loop Over Items').item.json[\"payload_params.visit_type\"] }}","type":"string"},{"id":"f09d2a1a-3ffb-4b6f-bc85-efa6042a92c9","name":"country_code","value":"={{ $('Loop Over Items').item.json[\"payload_params.country_code\"] }}","type":"string"},{"id":"3c82d0b1-7539-4e31-a9a2-fc26fab6aa46","name":"campaign_id","value":"={{ $('Loop Over Items').item.json[\"payload_params.campaign_id\"] }}","type":"string"},{"id":"a3222f81-32d6-4621-b331-08989dfd9e13","name":"course_id","value":"={{ $('Loop Over Items').item.json[\"payload_params.course_id\"] }}","type":"string"},{"id":"a1733abd-7823-4c8b-aff6-361c479d659c","name":"coming_from","value":"={{ $('Loop Over Items').item.json[\"payload_params.coming_from\"] }}","type":"string"},{"id":"40cdf32c-5927-40b4-b1f3-2e1a119962dd","name":"office_visit_id","value":"={{ $('Loop Over Items').item.json[\"payload_params.office_visit_id\"] }}","type":"string"},{"id":"7a58d090-f2d4-41d8-8702-ea77ca2662fa","name":"office_address","value":"={{ $('Loop Over Items').item.json[\"payload_params.office_address\"] }}","type":"string"},{"id":"d5125038-8488-4004-9cdb-7afe1f93bfce","name":"maps_link","value":"={{ $('Loop Over Items').item.json[\"payload_params.maps_link\"] }}","type":"string"},{"id":"7be1c763-ab39-4720-8df5-843e9ef32959","name":"spoc_name","value":"={{ $('Loop Over Items').item.json[\"payload_params.spoc_name\"] }}","type":"string"},{"id":"37c337cd-0584-49eb-a219-cc2c53000e82","name":"old_rescheduled_visit_id","value":"={{ $('Loop Over Items').item.json[\"payload_params.old_rescheduled_visit_id\"] }}","type":"string"},{"id":"cf016c73-30e0-4f86-ba39-fdb1490b1712","name":"registration_email","value":"={{ $('Loop Over Items').item.json[\"payload_params.registration_email\"] }}","type":"string"},{"id":"e3ebd5c5-ce12-48c0-a11d-321711ebcba7","name":"database_type","value":"={{ $('Loop Over Items').item.json[\"payload_params.database_type\"] }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1720,420],"id":"3df7df16-4b47-4913-8943-32779b8551b4","name":"Edit Fields","alwaysOutputData":true},{"parameters":{"workflowId":{"__rl":true,"mode":"list","value":"7BxbBnT5QnuqxTAF","cachedResultName":"Prep Payload for message sending"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1940,420],"id":"b4c24e10-57c3-4d93-b36b-6cd17b4a1ab2","name":"Execute Workflow","alwaysOutputData":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"9a842e26-ff25-42eb-99c6-0254776351f4","leftValue":"={{ $json.id }}","rightValue":"","operator":{"type":"number","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1180,440],"id":"69b1271d-bdbf-470d-8088-5604d148c14f","name":"If"}],"connections":{"When Executed by Another Workflow":{"main":[[{"node":"Code","type":"main","index":0}]]},"Loop Over Items":{"main":[[],[{"node":"Supabase","type":"main","index":0}]]},"Code":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Supabase":{"main":[[{"node":"If","type":"main","index":0}]]},"Supabase1":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Execute Workflow","type":"main","index":0}]]},"Execute Workflow":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"If":{"main":[[{"node":"Supabase1","type":"main","index":0}],[{"node":"Loop Over Items","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"When Executed by Another Workflow":[{"json":{"headers":{"host":"webhook.miles-api.com","x-real-ip":"172.71.223.140","x-forwarded-host":"webhook.miles-api.com","x-forwarded-server":"webhook.miles-api.com","x-forwarded-for":"44.199.15.1, 172.71.223.140","connection":"close","content-length":"980","cf-ray":"9551f17578e7207b-IAD","cf-connecting-ip":"44.199.15.1","accept-encoding":"gzip, br","x-forwarded-proto":"https","content-type":"application/x-www-form-urlencoded","user-agent":"Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0","cf-visitor":"{\"scheme\":\"https\"}","authorization":"Basic bmV0Y29yZTpuZXRjb3JlMTIz","cdn-loop":"cloudflare; loops=1","cf-ipcountry":"US"},"params":{},"query":{},"body":{"data":"{\"mileseducationcee\":[{\"webhook_name\":\"send-to-wati\",\"msgid\":\"-1\",\"payload_params\":{\"send_whatsapp\":\"true\",\"event_name\":\"did_not_visit_and_not_interested_doctors\",\"lead_id\":1,\"send_email\":\"false\",\"uuid\":\"33633840-5981-40c0-8774-5362df9228a5\",\"phone\":\"+917034347947\",\"email\":\"gopikaprasoon19@gmail.com\",\"course_id\":33,\"first_name\":\"Lead\"},\"channel\":\"custom_activity\",\"event_params\":{\"activity_source\":\"\",\"activity_id\":221,\"ts\":250625103733,\"foreignkey\":\"33633840-5981-40c0-8774-5362df9228a5\",\"timestamp\":\"2025-06-25T10:37:33\",\"identity\":\"\",\"activity_name\":\"did_not_visit_and_not_interested_doctors\",\"asset_id\":\"\",\"guid\":\"\"},\"journey_name\":\"did_not_visit_and_not_interested_doctors\"}]}"},"webhookUrl":"https://webhook.miles-api.com/webhook/fetch-event-from-netcore","executionMode":"production"}}]},"versionId":"31880bb9-27ca-43d3-b25f-42c8b4765403","triggerCount":0,"tags":[{"createdAt":"2025-07-15T07:07:49.926Z","updatedAt":"2025-07-15T07:07:49.926Z","id":"wJnVPrhSbmXUFztc","name":"martech"}]}]