[{"createdAt":"2025-03-17T08:35:35.117Z","updatedAt":"2025-07-15T07:15:05.000Z","id":"qfPNdamcEzlWb5fr","name":"wati-inv-tracking","active":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"wati-inv-tracking","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[20,160],"id":"6fe8ce9f-128a-465a-bbc7-508e391892a6","name":"Webhook","webhookId":"3100e46b-3965-4877-8268-7b3f18c6fb70"},{"parameters":{"respondWith":"json","responseBody":"=\n{\n\"campaignId\": {{ $('Edit Fields').first().json.campaignId }},\n\"campaignName\": \"{{ $json.campaign_name }}\",\n\"tokenId\": \"{{ $('Edit Fields').first().json.tokenId }}\",\n\"originalMessage\": \"{{ $('Edit Fields').first().json.originalMessage }}\",\n\"pageURL\": \"{{ $('Edit Fields').first().json.pageUrl }}\",\n\"lead_exists\": \"{{ $json.lead_exists }}\",\n\"uuid\": \"{{ $json.uuid ?? \"\" }}\",\n\"email\": \"{{ $json.email ?? \"\" }}\",\n\"name\": \"{{ $json.first_name ?? \"there\" }}\",\n\"spoc_name\": \"{{ $json.spoc_name ?? \"Rajeev\" }}\",\n\"spoc_phone\": \"{{ $json.spoc_phone ?? \"9513360196\" }}\"\n}","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1860,160],"id":"77df7d65-3e59-4b71-b589-d49d78e6bb0c","name":"Respond to Webhook"},{"parameters":{"jsCode":"function retrieveAndDecodeWhatsAppMessage(msg) {\n  const extractedData = extractHiddenData(msg);\n\n  return {\n    tokenId: extractedData.tokenId || \"b61e4967-edfb-4bb3-be64-dd14bf8052e6\",\n    campaignId: extractedData.campaignId || 18,\n    pageUrl: extractedData.pageUrl || \"wa-direct\",\n    originalMessage: msg.replace(/[\\u200B\\u200C\\u200D]/g, \"\") || \"extracted text\",\n  };\n}\n\nfunction extractHiddenData(message) {\n  // Extract only zero-width characters from the message\n  const hiddenPart = message.replace(/[^\\u200B\\u200C\\u200D]/g, \"\");\n\n  // Split hidden data using Zero-Width Joiner\n  const parts = hiddenPart.split(\"\\u200D\");\n\n  if (parts.length < 3) {\n    return { campaignId: null, tokenId: null, pageUrl: null };\n  }\n\n  const campaignId = parts[0].length; // ZW count = campaign ID\n  const tokenId = decodeUUID(parts[1]); // UUID from ZW\n  const pageUrl = decodeZeroWidthToText(parts[2]); // URL from ZW\n\n  return { campaignId, tokenId, pageUrl };\n}\n\nfunction decodeUUID(hiddenUUID) {\n  if (!hiddenUUID) return null;\n  const binaryUUID = hiddenUUID.replace(/\\u200B/g, \"0\").replace(/\\u200C/g, \"1\");\n  let hexUUID = \"\";\n  for (let i = 0; i < binaryUUID.length; i += 4) {\n    hexUUID += parseInt(binaryUUID.substr(i, 4), 2).toString(16);\n  }\n  return `${hexUUID.slice(0, 8)}-${hexUUID.slice(8, 12)}-${hexUUID.slice(12, 16)}-${hexUUID.slice(16, 20)}-${hexUUID.slice(20)}`;\n}\n\nfunction decodeZeroWidthToText(zeroWidthStr) {\n  const binaryStr = zeroWidthStr.replace(/\\u200B/g, \"0\").replace(/\\u200C/g, \"1\");\n  let text = \"\";\n  for (let i = 0; i < binaryStr.length; i += 8) {\n    const byte = binaryStr.substr(i, 8);\n    text += String.fromCharCode(parseInt(byte, 2));\n  }\n  return text;\n}\n\n// Main code\nconst message = $json.body.message;\nconst result = retrieveAndDecodeWhatsAppMessage(message);\n\nreturn [result];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[640,-160],"id":"b59a75d6-0ddd-45bb-8f67-096863fce3a7","name":"Code","onError":"continueRegularOutput"},{"parameters":{"assignments":{"assignments":[{"id":"cac8a121-93f8-4669-9b07-1774a12e1cba","name":"tokenId","value":"={{ $json.tokenId ?? \"abc\" }}","type":"string"},{"id":"0d7a3e05-a79b-4ad4-baae-86eff768e7eb","name":"campaignId","value":"={{ $json.campaignId == 0 ? 65 : $json.campaignId }}","type":"number"},{"id":"b358442d-2111-4d79-a2fa-d2b9f08cf091","name":"originalMessage","value":"={{ $json.originalMessage ?? \"Hi\" }}","type":"string"},{"id":"7d6ea97f-25cb-4d5f-8182-8faa6b8ddf93","name":"pageUrl","value":"={{ $json.pageUrl }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[860,-160],"id":"db6f25eb-6164-47d6-bf7e-ccd34846d38e","name":"Edit Fields"},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"campaign","mode":"name"},"returnAll":true,"where":{"values":[{"column":"id","value":"={{ $json.campaignId }}"}]},"options":{"outputColumns":["campaign_name","id"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1140,-160],"id":"f47e1663-dd30-4f4a-b1e1-e5d2af444d97","name":"Postgres","credentials":{"postgres":{"id":"UlHvqQraJFrdqkr2","name":"MF Prod Read"}}},{"parameters":{"workflowId":{"__rl":true,"mode":"list","value":"afBjx4OUvBQcsioa","cachedResultName":"Fetch Lead Details Based on Phone"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[620,420],"id":"061111bb-cc35-425e-9cd5-3ecc0b3526fc","name":"Execute Workflow","alwaysOutputData":true},{"parameters":{"mode":"combine","combineBy":"combineByPosition","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.1,"position":[1600,160],"id":"da1b763f-29a0-4fd2-8d80-f64545e9f237","name":"Merge"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"134a41fa-6dfb-4b5f-950d-e4991b63dc6e","leftValue":"={{ $json.lead_id }}","rightValue":"","operator":{"type":"number","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[840,420],"id":"dd8102e9-0818-4165-b74c-fe0a0fb150ed","name":"If"},{"parameters":{"assignments":{"assignments":[{"id":"b7f31aea-a69b-4d3a-860b-849fe789acca","name":"lead_exists","value":true,"type":"boolean"}]},"includeOtherFields":true,"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1180,320],"id":"f0a48df5-6098-4540-b963-a202f4843762","name":"Edit Fields1"},{"parameters":{"assignments":{"assignments":[{"id":"b7f31aea-a69b-4d3a-860b-849fe789acca","name":"lead_exists","value":false,"type":"boolean"}]},"includeOtherFields":true,"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1180,520],"id":"e6e2b17f-4c0c-4e67-b93a-74318a67c9bf","name":"Edit Fields2"}],"connections":{"Webhook":{"main":[[{"node":"Code","type":"main","index":0},{"node":"Execute Workflow","type":"main","index":0}]]},"Code":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Postgres","type":"main","index":0}]]},"Postgres":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Execute Workflow":{"main":[[{"node":"If","type":"main","index":0}]]},"Merge":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"If":{"main":[[{"node":"Edit Fields1","type":"main","index":0}],[{"node":"Edit Fields2","type":"main","index":0}]]},"Edit Fields1":{"main":[[{"node":"Merge","type":"main","index":1}]]},"Edit Fields2":{"main":[[{"node":"Merge","type":"main","index":1}]]}},"settings":{"executionOrder":"v1","timezone":"Asia/Kolkata","saveExecutionProgress":true,"callerPolicy":"workflowsFromSameOwner","errorWorkflow":"JugK3JVukMVLS3ax"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook":[{"json":{"headers":{"host":"webhook.miles-api.com","x-real-ip":"162.158.189.238","x-forwarded-host":"webhook.miles-api.com","x-forwarded-server":"webhook.miles-api.com","x-forwarded-for":"34.87.84.167, 162.158.189.238","connection":"close","content-length":"5315","cf-ray":"94ce1742cf783fa0-SIN","cf-connecting-ip":"34.87.84.167","accept-encoding":"gzip, br","x-forwarded-proto":"https","content-type":"application/json; charset=UTF-8","tracestate":"dd=s:0;p:f3ab44afcb208db8","cf-visitor":"{\"scheme\":\"https\"}","traceparent":"00-e6ba29cc09d75a3ce30a1b7d5c82d0b0-f3ab44afcb208db8-00","x-datadog-tags":"_dd.p.tid=e6ba29cc09d75a3c","cdn-loop":"cloudflare; loops=1","cf-ipcountry":"SG","x-datadog-sampling-priority":"0","x-datadog-parent-id":"17558203094051884472","x-datadog-trace-id":"16359918821613686960"},"params":{},"query":{},"body":{"message":"Hello, ​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​‍‌‌‌​​​‌‌‌​‌​​​‌​​‌‌​‌​​​‌‌​​‌‌‌‌​‌​​​​‌​​​​​‌‌​​​‌​​​​​‌​‌​‌‌‌​​‌​‌​​​‌​​​‌‌​‌​​​​‌​‌​​​​​‌​​‌​‌‌‌​‌‌​​​​‌‌‌‌​​​‌‌‌​​‌‌​‌​​​‌​​​‍​‌‌​‌​​​​‌‌‌​‌​​​‌‌‌​‌​​​‌‌‌​​​​​‌‌‌​​‌‌​​‌‌‌​‌​​​‌​‌‌‌‌​​‌​‌‌‌‌​‌‌‌​‌‌‌​‌‌‌​‌‌‌​‌‌‌​‌‌‌​​‌​‌‌‌​​‌‌​‌‌​‌​‌‌​‌​​‌​‌‌​‌‌​​​‌‌​​‌​‌​‌‌‌​​‌‌​‌‌​​‌​‌​‌‌​​‌​​​‌‌‌​‌​‌​‌‌​​​‌‌​‌‌​​​​‌​‌‌‌​‌​​​‌‌​‌​​‌​‌‌​‌‌‌‌​‌‌​‌‌‌​​​‌​‌‌‌​​‌‌​​​‌‌​‌‌​‌‌‌‌​‌‌​‌‌​‌​​‌​‌‌‌‌​‌‌​​​​‌​‌‌​​​‌‌​‌‌​​​‌‌​‌‌​‌‌‌‌​‌‌‌​‌​‌​‌‌​‌‌‌​​‌‌‌​‌​​​‌‌​‌​​‌​‌‌​‌‌‌​​‌‌​​‌‌‌​​‌​‌‌‌‌​‌‌‌​‌​‌​‌‌‌​​‌‌​​‌​‌‌​‌​‌‌​​​‌‌​‌‌‌​​​​​‌‌​​​​‌‍​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​‍‌‌‌​​​‌‌‌​‌​​​‌​​‌‌​‌​​​‌‌​​‌‌‌‌​‌​​​​‌​​​​​‌‌​​​‌​​​​​‌​‌​‌‌‌​​‌​‌​​​‌​​​‌‌​‌​​​​‌​‌​​​​​‌​​‌​‌‌‌​‌‌​​​​‌‌‌‌​​​‌‌‌​​‌‌​‌​​​‌​​​‍​‌‌​‌​​​​‌‌‌​‌​​​‌‌‌​‌​​​‌‌‌​​​​​‌‌‌​​‌‌​​‌‌‌​‌​​​‌​‌‌‌‌​​‌​‌‌‌‌​‌‌‌​‌‌‌​‌‌‌​‌‌‌​‌‌‌​‌‌‌​​‌​‌‌‌​​‌‌​‌‌​‌​‌‌​‌​​‌​‌‌​‌‌​​​‌‌​​‌​‌​‌‌‌​​‌‌​‌‌​​‌​‌​‌‌​​‌​​​‌‌‌​‌​‌​‌‌​​​‌‌​‌‌​​​​‌​‌‌‌​‌​​​‌‌​‌​​‌​‌‌​‌‌‌‌​‌‌​‌‌‌​​​‌​‌‌‌​​‌‌​​​‌‌​‌‌​‌‌‌‌​‌‌​‌‌​‌​​‌​‌‌‌‌​‌‌​​​​‌​‌‌​​​‌‌​‌‌​​​‌‌​‌‌​‌‌‌‌​‌‌‌​‌​‌​‌‌​‌‌‌​​‌‌‌​‌​​​‌‌​‌​​‌​‌‌​‌‌‌​​‌‌​​‌‌‌​​‌​‌‌‌‌​‌‌‌​‌​‌​‌‌‌​​‌‌​​‌​‌‌​‌​‌‌​​​‌‌​‌‌​‌‌​‌​‌‌​​​​‌‍I have a question about Miles' Courses.","phone":"91123"},"webhookUrl":"https://webhook.miles-api.com/webhook/wati-inv-tracking","executionMode":"production"}}]},"versionId":"1484d702-a0ae-4f55-9a3f-eecc6d12ab14","triggerCount":1,"tags":[{"createdAt":"2025-07-15T07:07:49.926Z","updatedAt":"2025-07-15T07:07:49.926Z","id":"wJnVPrhSbmXUFztc","name":"martech"}]}]