{
  "active": true,
  "connections": {
    "Supabase": {
      "main": [
        [
          {
            "node": "Supabase2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres": {
      "main": [
        [
          {
            "node": "Item Lists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Item Lists": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request1": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres1": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase2": {
      "main": [
        [
          {
            "node": "Supabase3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase3": {
      "main": [
        [
          {
            "node": "Postgres1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Supabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "Postgres",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-02-21T10:25:12.545Z",
  "id": "wLCrp5Mga1Yq6GJK",
  "meta": null,
  "name": "Sync Office Visit ME<>MF",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "send-visit-office-to-mf",
        "options": {}
      },
      "id": "f92a70a8-f3d0-4040-a28c-0caed0198a21",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -520,
        0
      ],
      "webhookId": "2ab4870d-10f8-436f-810f-f4c8a8c6d1b2"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "leads_dump",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "keyValue": "={{ $json.body.leads_dump_id }}"
            }
          ]
        }
      },
      "id": "e60e0eb2-bcb5-4400-a919-8e486f3f1cb6",
      "name": "Supabase",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -100,
        0
      ],
      "credentials": {
        "supabaseApi": {
          "id": "6stEFLC7gtftREcf",
          "name": "Supabase Campaign manager"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  \"public\".\"lead\".\"id\" AS \"id\",\n  \"public\".\"lead\".\"updated_by\" AS \"updated_by\",\n  \"public\".\"lead\".\"created_at\" AS \"created_at\",\n  \"public\".\"lead\".\"candidate_id\" AS \"candidate_id\",\n  \"public\".\"lead\".\"first_name\" AS \"first_name\",\n  \"public\".\"lead\".\"last_name\" AS \"last_name\",\n  \"public\".\"lead\".\"city\" AS \"city\",\n  \"public\".\"lead\".\"intrested_to_work_in_us\" AS \"intrested_to_work_in_us\",\n  \"public\".\"lead\".\"call_status\" AS \"call_status\",\n  \"public\".\"lead\".\"last_call_date\" AS \"last_call_date\",\n  \"public\".\"lead\".\"spocId\" AS \"spocId\",\n  \"public\".\"lead\".\"srSpocId\" AS \"srSpocId\",\n  \"public\".\"lead\".\"created_by\" AS \"created_by\",\n  \"public\".\"lead\".\"uuid\" AS \"uuid\",\n  \"public\".\"lead\".\"graduation_year\" AS \"graduation_year\",\n  \"public\".\"lead\".\"followup_date\" AS \"followup_date\",\n  \"public\".\"lead\".\"re_enquiry_date\" AS \"re_enquiry_date\",\n  \"Phone\".\"phoneNumber\" AS \"Phone__phoneNumber\",\n  \"Phone\".\"countryCode\" AS \"Phone__countryCode\",\n  \"Email\".\"email\" AS \"Email__email\",\n  \"User - SpocId\".\"firstName\" AS \"User - SpocId__firstName\",\n  \"User - SpocId\".\"official_number\" AS \"User - SpocId__official_number\",\n  \"User - SpocId\".\"employee_id\" AS \"User - SpocId__employee_id\"\nFROM\n  \"public\".\"lead\"\nLEFT JOIN \"public\".\"phone\" AS \"Phone\" ON \"public\".\"lead\".\"id\" = \"Phone\".\"leadId\"\n  LEFT JOIN \"public\".\"email\" AS \"Email\" ON \"public\".\"lead\".\"id\" = \"Email\".\"leadId\"\n  LEFT JOIN \"public\".\"user\" AS \"User - SpocId\" ON \"public\".\"lead\".\"spocId\" = \"User - SpocId\".\"id\"\nwhere \"Phone\".\"phoneNumber\" = '{{ $json.normalizedPhoneNumber.slice(3) }}'",
        "options": {}
      },
      "id": "2264d470-9cb2-4ac6-b688-e7eed282bd04",
      "name": "Postgres",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.2,
      "position": [
        1080,
        0
      ],
      "credentials": {
        "postgres": {
          "id": "VPJUosohtvWNBW4H",
          "name": "MF Prod (DO NOT USE)"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mfx-prod-154625965269.asia-south1.run.app/office-visit/add",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.result.token }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"visit_date\": \"{{ $('Webhook').item.json.body.time_slots }}\",\n  \"schedule\": {{ $('Webhook').item.json[\"body\"][\"city\"]==\"Virtual Meeting\" ?1:2 }},\n  \"visit_status\": 1,\n  \"lead\": {{ $('Postgres').item.json[\"id\"] }},\n  \"visit_city\": {{ $('Postgres1').item.json[\"id\"]??2 }},\n  \"spoc\": {{ $('Postgres').item.json[\"spocId\"] ?? 58 }},\n  \"source\": 1,\n  \"gm_approvel\": true\n}",
        "options": {}
      },
      "id": "ab03c2b3-4813-46de-88d1-6d811faa78e2",
      "name": "HTTP Request",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        1760,
        0
      ],
      "retryOnFail": true,
      "waitBetweenTries": 5000
    },
    {
      "parameters": {
        "operation": "limit"
      },
      "id": "34c78211-c1a1-45ed-bbde-d8c554296fe5",
      "name": "Item Lists",
      "type": "n8n-nodes-base.itemLists",
      "typeVersion": 3,
      "position": [
        1300,
        0
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mfx-prod-154625965269.asia-south1.run.app/auth/login",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n    \"email\": \"jithin.kumar@mileseducation.com\",\n    \"password\": \"123\"\n}",
        "options": {}
      },
      "id": "09c87395-6cbe-4304-9ae7-b08ac4236b00",
      "name": "HTTP Request1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        1520,
        0
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "miles_locations",
        "filters": {
          "conditions": [
            {
              "keyName": "location_name",
              "keyValue": "={{ $('Webhook').item.json.body.city }}"
            }
          ]
        }
      },
      "id": "700f7fef-c8d2-472c-87f6-bc37390dd28d",
      "name": "Supabase1",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        180,
        260
      ],
      "credentials": {
        "supabaseApi": {
          "id": "6stEFLC7gtftREcf",
          "name": "Supabase Campaign manager"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "miles_office",
          "mode": "list",
          "cachedResultName": "miles_office"
        },
        "where": {
          "values": [
            {
              "column": "city",
              "value": "={{ $('Webhook').first().json.body.city }}"
            }
          ]
        },
        "options": {}
      },
      "id": "ae95e0bc-7161-488c-888f-4108a10ec1ad",
      "name": "Postgres1",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.2,
      "position": [
        560,
        0
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "VPJUosohtvWNBW4H",
          "name": "MF Prod (DO NOT USE)"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "campaign",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "keyValue": "={{ $json.camp_id?? 65 }}"
            }
          ]
        }
      },
      "id": "bca3bd7f-382b-4cfe-9fee-b52b55e0f0b7",
      "name": "Supabase2",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        120,
        0
      ],
      "credentials": {
        "supabaseApi": {
          "id": "6stEFLC7gtftREcf",
          "name": "Supabase Campaign manager"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "campaign_source",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "keyValue": "={{ $json.source }}"
            }
          ]
        }
      },
      "id": "6dafd241-dbb2-41ac-a36c-5e52dd968c86",
      "name": "Supabase3",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        340,
        0
      ],
      "credentials": {
        "supabaseApi": {
          "id": "6stEFLC7gtftREcf",
          "name": "Supabase Campaign manager"
        }
      }
    },
    {
      "parameters": {
        "amount": 10,
        "unit": "seconds"
      },
      "id": "a2184d5c-b5b8-480b-a637-e9bdf6631201",
      "name": "Wait",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        -300,
        0
      ],
      "webhookId": "e8cf5c85-5423-4633-a807-e570a916e87f"
    },
    {
      "parameters": {
        "jsCode": "const number = $('Supabase').first().json.phone;  // Fetch single input number\nconst cleanNumber = number.toString().replace(/\\D/g, '');\n\nlet normalizedNumber;\n\nif (cleanNumber.startsWith('+91') && cleanNumber.length === 13) {\n    normalizedNumber = cleanNumber;\n} else if (cleanNumber.startsWith('91') && cleanNumber.length === 12) {\n    normalizedNumber = '+91' + cleanNumber.slice(2);\n} else if (cleanNumber.length === 10) {\n    normalizedNumber = '+91' + cleanNumber;\n} else {\n    normalizedNumber = '+' + cleanNumber;\n}\n\nreturn [{ json: { normalizedPhoneNumber: normalizedNumber } }];"
      },
      "id": "478b08ad-d8df-4915-94cf-21a425eb63c0",
      "name": "Code1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        820,
        0
      ]
    }
  ],
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "webhook.miles-api.com",
            "x-real-ip": "172.69.87.148",
            "x-forwarded-host": "webhook.miles-api.com",
            "x-forwarded-server": "webhook.miles-api.com",
            "x-forwarded-for": "2406:da1a:6b0:f602:fc46:c2c9:8a32:fafb, 172.69.87.148",
            "connection": "close",
            "content-length": "369",
            "cf-ray": "91a83810ed8346f5-BOM",
            "cf-connecting-ip": "2406:da1a:6b0:f602:fc46:c2c9:8a32:fafb",
            "accept-encoding": "gzip, br",
            "cf-pseudo-ipv4": "240.81.65.233",
            "x-forwarded-proto": "https",
            "content-type": "application/json",
            "charsets": "utf-8",
            "cf-ipcountry": "IN",
            "accept": "*/*",
            "cdn-loop": "cloudflare; loops=1",
            "user-agent": "PostgreSQL 15.1 (Ubuntu 15.1-1.pgdg20.04+1) on aarch64-unknown-linux-gnu, compiled by gcc (Ubuntu 9.4.0-1ubuntu1~20.04.1) 9.4.0, 64-bit"
          },
          "params": {},
          "query": {},
          "body": {
            "id": 159095,
            "city": "Ahmedabad",
            "spoc_gm": null,
            "spoc_name": null,
            "status_gm": null,
            "created_at": "2025-03-26T11:00:36.39713+00:00",
            "spoc_phone": null,
            "time_slots": "2025-03-27T15:00:00",
            "visit_date": null,
            "status_spoc": null,
            "flow_started": null,
            "meeting_type": 1,
            "visit_status": null,
            "leads_dump_id": 660947,
            "visit_date_string": "2025-03-27 "
          }
        }
      }
    ]
  },
  "settings": {
    "executionOrder": "v1",
    "timezone": "Asia/Calcutta",
    "saveExecutionProgress": true,
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "JugK3JVukMVLS3ax"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-04-14T06:56:48.000Z",
  "versionId": "6304117e-7ff2-4914-9fa8-9747dd8a7382"
}